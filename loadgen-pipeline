pipeline {
    agent any
    stages {
    
        stage('Fresh workspace') {
            steps {
                sh 'rm -rf /var/lib/jenkins/workspace/loadgen/loadgen'
            }
        }
        stage('Git clone') {
            steps {
                sh 'git clone https://github.com/vnskln/loadgen.git'
            }
        }
        stage('Clean') {
            steps {
                sh './mvnw clean package'
            }
        }
        stage('Build') {
            steps {
                sh 'docker build --tag loadgen-0.0.1 .'
            }

            post {
                success {
                    junit '**/target/surefire-reports/TEST-*.xml'
                    archiveArtifacts 'target/*.jar'
                }
            }
        }
        stage('Deploy') {
            steps {
               sh 'docker-compose up -d'
            }
        }
        stage('Stop&Clean') {
            steps {
               input 'Stop containers?'
               sh 'docker-compose rm -fsv'
               sh 'echo y | docker system prune'
            }
        }
    }
}
